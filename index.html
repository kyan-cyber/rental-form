<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>貸出フォーム</title>
</head>
<body>
  <h1>貸出フォーム</h1>

  <!-- ✅ formタグの開始を追加 -->
  <form id="rentalForm">
    <input type="hidden" id="userId" name="userId">
    <label>物品:</label><input type="text" id="item" name="item"><br>
    <label>操作:</label>
    <select id="action" name="action">
      <option value="貸出">貸出</option>
      <option value="返却">返却</option>
    </select><br>
    <button type="submit">送信</button>
  </form>

  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // URLから item 名を取得してフォームに反映
    const urlParams = new URLSearchParams(window.location.search);
    const itemName = urlParams.get('item');
    document.getElementById("item").value = itemName;

    // LIFF初期化
    liff.init({ liffId: "2007393082-pVb8R9dQ" }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          const userId = profile.userId;
          document.getElementById("userId").value = userId;

          // GAS に貸出状況確認
          fetch(`https://script.google.com/macros/s/AKfycbzShpUoHT-Uupu-8YeGsXZIPxkwtmWqad6v66f3Oo17TfWDiurMSdSoo3E2ZaLIDs63/exec?userId=${userId}&item=${itemName}`)
            .then(res => res.json())
            .then(result => {
              if (result.status === "貸出中") {
                document.getElementById("action").value = "返却";
              } else {
                document.getElementById("action").value = "貸出";
              }
            });

          // フォーム送信処理
          document.getElementById("rentalForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const data = {
              userId: userId,
              item: document.getElementById("item").value,
              action: document.getElementById("action").value
            };
            fetch(`https://script.google.com/macros/s/AKfycbzShpUoHT-Uupu-8YeGsXZIPxkwtmWqad6v66f3Oo17TfWDiurMSdSoo3E2ZaLIDs63/exec`, {
              method: "POST",
              body: JSON.stringify(data),
              headers: { "Content-Type": "application/json" }
            }).then(() => {
              alert("送信しました");
              liff.closeWindow();
            });
          });
        });
      }
    }).catch(err => {
      console.error("LIFF初期化エラー:", err);
    });
  </script>
</body>
</html>
